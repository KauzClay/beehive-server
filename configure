#!/bin/bash
oldDir=`pwd`
[ `whoami` = root ] || { sudo "$0" "$@"; exit $?; }

set -e

# Install all of the dependencies that the Waggle server needs
# Get the IP for the cassandra node you want to send data to.

if [ ${CASSANDRA_SERVER}x == "x" ] ; then
  read -p "Enter the IP address or hostname of the Cassandra server you want to use: " c_ip
else
  export c_ip=${CASSANDRA_SERVER}
fi

set -x

mkdir -p /etc/waggle/
echo $c_ip > /etc/waggle/cassandra_ip


export PLATFORM=`uname -i`

if [ ${PLATFORM} == "armv7l"  ]  ; then
  echo "Architecture: armv7l"
  dpkg -i packages_o/*.deb
  
  cd packages_o/
  pip install blist
  pip install cassandra-driver

  cd pika-0.9.14/
  python setup.py install
  # install pika from waggle git repo !
  #pip install pika
  # or specific version if needed: pip install pika==0.9.14
  cd ../..

elif [ ${PLATFORM} == "x86_64"  ] ; then
  echo "Architecture: x86_64"
else
  echo "Architecture not supported"
fi




echo 0 > /etc/waggle/hostname # The cloud's hostname is defined as 0

# All of the general configuration files for Waggle are stored here
mkdir -p /usr/lib/waggle
echo Moving waggle server folder to proper place.
cd ..

# All of the code is copied into the /usr/lib/waggle folder
cp --recursive server/ /usr/lib/waggle/
cp --recursive devtools/protocol_common/* /usr/lib/waggle/

# Create a user that all nodes can use to send info to.
# Feel free to fiddle with rabbitmq if you want to have other users and accounts.
if [ $(rabbitmqctl list_users | grep -c waggle) -eq 0 ] ; then 
  echo "add waggle user"  
  rabbitmqctl add_user waggle waggle
  rabbitmqctl set_permissions waggle ".*" ".*" ".*"
fi

# Set up the SSL files, and generate a new SSL Certificate Authority
# For the Certificate Authority setup, see waggle/server/SSL/caconfig.sh
echo Setting up SSL
mkdir -p /usr/lib/waggle/SSL
cp -r /usr/lib/waggle/server/SSL/* /usr/lib/waggle/SSL
cd /usr/lib/waggle/SSL/
source caconfig.sh
chmod 777 -R /usr/lib/waggle

exit 0
cd $oldDir
